### **SQL语句是如何被执行的**

#### MySQL基础架构分析

![](https://camo.githubusercontent.com/7ef46ccad045efe1f2aadedcabbc69bb3f4108b9/68747470733a2f2f757365722d676f6c642d63646e2e786974752e696f2f323031392f332f32332f313639613862633630613038333834393f773d39353026683d3130363226663d6a70656726733d3338313839)

MySQL总的分为Server层和存储引擎层：

Server层：

- 连接层

  主要和身份认证和权限管理相关。

  主要负责用户登录数据库，进行用户的身份认证，包括校验账户密码，权限等操作，如果用户账户密码已通过，连接器会到权限表中查询该用户的所有权限，之后在这个连接里的权限逻辑判断都是会依赖此时读取到的权限数据，也就是说，后续只要这个连接不断开，即时管理员修改了该用户的权限，该用户也是不受影响的。

- 查询缓存（**MySQL8.0版本后移除**）

  查询缓存主要用来缓存我们所执行的SELECT语句以该语句的结果集

  连接建立后，执行查询语句的时候，会先查询缓存，MySQL 会先校验这个 sql 是否执行过，以 Key-Value 的形式缓存在内存中，Key 是查询预计，Value 是结果集。如果缓存 key 被命中，就会直接返回给客户端，如果没有命中，就会执行后续的操作，完成后也会把结果缓存起来，方便下一次调用。当然在真正执行缓存查询的时候还是会校验用户的权限，是否有该表的查询条件。

  MySQL 查询不建议使用缓存，因为查询缓存失效在实际业务场景中可能会非常频繁，假如你对一个表更新的话，这个表上的所有的查询缓存都会被清空。对于不经常更新的数据来说，使用缓存还是可以的。

  所以，一般在大多数情况下我们都是不推荐去使用查询缓存的。

  MySQL 8.0 版本后删除了缓存的功能，官方也是认为该功能在实际的应用场景比较少，所以干脆直接删掉了。

- 分析器

  如果没有命中缓存，就会直接进行分析器。

  分析器主要用来分析SQL语句，包括词法分析和语法分析。

  词法分析用来提取关键字，提取查询条件等。

  语法分析用来判断是否符合SQL语法

- 优化器

  优化器的作用就是它认为的最优的执行方案去执行（有时候可能也不是最优，这篇文章涉及对这部分知识的深入讲解），比如多个索引的时候该如何选择索引，多表查询的时候如何选择关联顺序等。

- 执行器

  选择了执行方案后，MySQL就准备开始执行了。首先判断用户是否具有需要的权限，没有直接返回错误信息。有则调用引擎的接口，返回执行结果。

