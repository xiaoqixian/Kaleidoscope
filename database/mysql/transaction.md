### **事务**

MySQL事务主要用于处理操作量大，复杂度高的数据。比如在人员管理系统中删除一个人员时，需要删除基本资料，职务信息等，这些往往不是存储在一个数据表中的，所有这些数据库语句就构成了一个事务。

MySQL中只有使用了InnoDB引擎的数据库或表才支持事务。

事务可以保证语句执行的完整性，一个事务的所有语句要么均被正确地执行，要么都没有执行。

一般事务需要满足四个性质：

- 原子性：一个事务所有的语句执行看做一个整体，要么都完成，要么都没有完成。如果中间发生差错，数据表就会回滚到事务前的状态。

- 一致性：事务开始之前和结束之后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设规则，这包含资料的精确度、串联性以及后续数据库可以自发性地完成预定的工作。

- 隔离性：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时而导致数据的不一致。

  隔离事务分为不同级别：读未提交（Read uncommitted），读提交（Read committed），可重复读（repeatable read），串行化（Serializable）

- 持久性：事务处理结束后，对数据的修改是永久的。

#### 事务控制语句

- BEGIN或者START TRANSACTION：显式地开启一个事务；
- COMMIT：提交事务，并对数据库造成永久性的修改；
- ROLLBACK：回滚会结束用户的事务，并撤销所有正在进行的**未提交**的修改
- SAVEPOINT identifier：在事务创建一个保存点，一个事务中允许创建多个保存点；
- RELEASE SAVEPOINT identifier：删除一个事务的保存点，没有指定保存点的话会报错；
- ROLLBACK TO identifier：将事务回滚到某个保存点；
- SET TRANSACTION：用来设置事务的隔离级别；

#### 自动提交特性

MySQL另一种开启事务的方式是设置自动提交的开启与关闭。

`SET autocommit = 0|1; `

0表示关闭自动提交，1表示开启自动提交。

如果关闭了自动提交，则所有SQL语句执行后同样需要commit以后才能生效。

与上一种方式的区别是`SET autocommit`可以永久改变服务器的设置，直到下次修改该设置。

而`BEGIN`则是记录开启前的状态，一旦事务提交或回滚后就需要再次开启事务。

#### 事务的原理

事务的原理正是利用了上面提到的数据库的自动提交特性。开启一个事务后会暂时关闭“自动提交”机制，需要commit提交持久化数据操作。