---
author: lunar
date: Sun 09 Aug 2020 05:32:19 PM CST
---

### **布隆过滤器**

HyperLogLog有能力从有重复元素的集合里找到所有不重复的元素个数，但是想要统计一个元素是否已经在一个集合里面就无能为力。

布隆过滤器（Bloom Fielter）就是专门用来解决去重问题的高级数据结构。但是同HyperLogLog一样，存在一定的不精确性，但是可以在空间上节省90%以上。

#### 介绍

布隆过滤器是一个很长的二进制向量和一系列随机映射函数。但布隆过滤器说某个值存在时，这个可能不存在；当布隆过滤器说不存在时，就一定不存在。

#### 使用场景

- 大数据判断是否存在：服务器内存足够大的话可以考虑使用哈希，否则使用布隆过滤器。

- 解决缓存穿透：如果有大量请求一个不存在的缓存，那么每次都不能在缓存中命中，导致大量请求来到数据库，造成缓存穿透。布隆过滤器可以用来解决这个问题。

- 爬虫/邮箱等系统的过滤

#### 原理

布隆过滤器本质上是一个m位的位向量，初始值均为0。当我们向布隆过滤器添加数据时，会使用多个hash函数对key进行运算，算得一个证书索引值，然后对位向量长度进行取模运算得到一个位置，每个hash函数会算得一个不同的位置。再把位数组的这几个位置都置为1就完成了`add`操作。

向布隆过滤器查询`key`是否存在时，跟`add`操作一样，会把这个`key`进行多个相同的`hash`函数运算，如果相应的位置均为1，则说明存在。只要有一个为0，就说明不存在。

从这两点我们可以窥探到布隆过滤器不精确性的原因：布隆过滤器正是利用多个hash函数叠加的小概率性来保证key的唯一性。只有当key足够多时，才有可能两个不同的key在经过多个hash函数计算后取模会结果都一样。

因此布隆过滤器的使用要注意以下几点：

1. 使用时不要让实际元素数量远大于位向量长度；

2. 当元素数量逐渐增多时，增加hash函数的数量只能缓解一定的重复性，根本性的解决只能增加位向量的长度。

#### 布隆过滤器的使用

布隆过滤器有两条基本指令，`bf.add`添加元素，`bf.exists`查询元素是否存在。`bf.add`一次只能添加一个元素，如果需要一次添加多个元素，可以使用`bf.madd`指令。

在Redis中，第一次使用`bf.add`指令添加元素的时候会自动创建一个布隆过滤器。如果想要手动创建布隆过滤器，可以使用`bf.reserve`指令。

`bf.reserve`有三个参数：`key`, `error_rate`和`initial_size`:
- `error_rate`: 错误率，错误率越低，需要的空间越大；
- `initial_size`: 表示预计放入的元素数量，当实际元素数量超过这个值时，错误率会提升，所以需要提前设置一个较大的数量避免误判率升高。
