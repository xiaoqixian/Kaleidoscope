---
author: lunar
date: Thu 06 Aug 2020 03:53:47 PM CST
---

### **分布式锁**

**锁**是一种用来解决多个执行线程访问共享资源错误或者数据不一致问题的工具。

一般情况下，主要有两个场景使用分布式锁：

1. 避免不同节点重复相同的工作：比如用户执行某个操作可能会向不同节点发送多封邮件；
2. 避免破坏数据的正确性：如果两个节点在同一个数据上进行操作，可能会造成数据的不一致。

#### Redis分布式锁的问题

1. 锁超时

   如果一台服务器A获取到锁后突然挂了，那么其它服务器就可能永远不能获取到锁。

   所以需要为锁设置一个超时时间来保证服务的可行性。

   但是有可能一些服务本身需要执行很长的时间，这就导致可能任务没有执行完成，而锁就已经超时了。那样依然可能发生错误。

   有一个稍微安全一点的方案是 **将锁的 `value` 值设置为一个随机数**，释放锁时先匹配随机数是否一致，然后再删除 key，这是为了 **确保当前线程占有的锁不会被其他线程释放**，除非这个锁是因为过期了而被服务器自动释放的。

   但是匹配 `value` 和删除 `key` 在 Redis 中并不是一个原子性的操作，也没有类似保证原子性的指令，所以可能需要使用像 Lua 这样的脚本来处理了，因为 Lua 脚本可以 **保证多个指令的原子性执行**。