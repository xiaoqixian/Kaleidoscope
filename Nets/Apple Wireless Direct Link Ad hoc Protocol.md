# Apple Wireless Direct Link Ad hoc Protocol

### 介绍

​	Apple Wireless Direct Link (AWDL) 是苹果的一项专利协议，其部署在超过12亿的组成苹果用户生态的终端设备之上，使用其的应用包括AirDrop和AirPlay等。

​	AWDL协议有以下几点值得注意：

1. AWDL基于IEEE 802.11 协议，可能存在潜在的性能和共存问题，尤其是在一般环境下，AWDL使用多条信道并且使用跳频技术，可能与现有的Wi-Fi部署存在干扰问题。
2. 在现有版本的macOS中，Wi-Fi驱动是最大的二进制内核扩展。鉴于最近发布的Wi-Fi芯片固件[7,8]中的漏洞可能会导致整个系统对[9]的破坏，我们强烈建议对该协议及其实现进行安全审计，因为非标准化协议中的漏洞更有可能发生。
3. 对该协议重新实现并开源将允许与其它操作系统互操作，最终实现高吞吐量的跨平台直接通信。

​	在本文中，我们通过二进制和运行时分析的方式对AWDL进行了一个详细的分析，并给出了其帧结构和运行方式。简单来说，AWDL是一种基于IEEE 802.11 标准并利用了允许自定义协议实现的供应商扩展来实现的协议。每个AWDL节点会定期发送action frames，其包含了一系列空闲窗口，表明其随时可与其它AWDL节点进行通信。之后一个主节点被选举出来来同步这些窗口序列。在这些空闲窗口中，节点之间可以通过一种专用的数据帧格式来彼此通信。在空闲窗口之外，节点可以将其Wi-Fi无线电调节到另一个频道来与AP点进行通信，或者直接关闭来节省电量。本文所做的工作如下：

- 提供了对于macOS操作系统和其Wi-Fi驱动架构和debugging设施的剖析
- 4到6节提供了AWDL的帧结构和运行方式
- 对AWDL进行了实验性分析来评估选举行为，同步准确性，吞吐量和跳频策略。
- 讨论了协议的复杂度，能量利用效率，并进行了初步的安全性评估，在那一步发现了macOS内核扩展中的权限安全性问题。

### 背景

​	**IEEE 802.11 IBSS**.  IBSS(Independent Basic Service Set，独立基本服务集)模式更为熟知的名字是"ad hoc"模式，该模式创建一个并无特殊控制角色的分布式无线网络。IBSS 可通过在特定频道发送一个带有SSID和BSSID的信标帧(beacon frame)来创建。其它节点也可通过发送带有相同信息的信标帧来加入网络。

​	**Wi-Fi Peer to Peer**.  点对点Wi-Fi，也称为直连Wi-Fi，可以允许在无基站的情况下连接多台设备。在运行过程中，一个节点承担群组所有者(Group Owner，GO)的角色，这与基础架构模式(或BSS)非常相似。GO的角色无法转移到其它设备，如果GO离开了网络，则必须创建一个新的网络。点对点Wi-Fi网络是通过监听单个频道并发送探针到其它所有频道来建立的。这在实际中会给连接过程带来延迟，经过实验发现建立连接的过程会消耗4到10秒[11]。因此发现设备的过程会迅速消耗设备电量。

​	**TDLS**.  隧道直连建立(Tunneled Direct Link Setup, TDLS)是一项IEEE 802.11 标准的扩展，其允许两个处于同一BSS的节点进行直连。在没有TDLS的网络中，所有的节点流量都要通过AP进行，即使两个节点离得很近。TDLS要求两个节点都连接到同一个AP，因为控制帧需要通过AP进行传输，因此无法运用于真实的ad hoc 场景中。

​	**Neighbor Awareness Networking**.  邻节点感知网络(NAN)[35]，也被称为Wi-Fi感知，扩展了IEEE 802.11的接近服务发现。NAN被设计为高能效的，允许在电池供电的设备[12]上连续运行。NAN在Android 8[17]中被支持，但是我们没有找到任何与兼容硬件的设备。NAN依赖于从一个被选举的主节点发送的信标帧。它们同步一个区域内所有设备的时间。在一个短的发现窗口主设置，设备可以打开他们的无线电，交换服务和连接信息(例如，Wi-Fi P2P参数)，并再次关闭他们的收音机。事实上，我们发现AWDL使用了与NAN类似的概念，但实际实现与NAN有很大的不同。此外，NAN没有一个用于传输用户数据的数据路径。

​	**Bluetooth**.  蓝牙是一个有着不同物理和MAC层的独立标准。蓝牙和Wi-Fi一样工作在2.4GHz频域，并且经常和Wi-Fi集成到一个芯片上以共享天线。低能耗蓝牙(Bluetooth Low Energy, BLE)是与经典蓝牙协议不兼容的协议，其为低能源消耗而优化，因此提供的带宽非常有限。可用的BLE4.2 最大数据传输速率为 394 kbit/s[14]。其通常应用于小型电池驱动设备，如智能手表。BLE不是为大数据传输而设计的，但是可以应用于引导像AWDL这样的高带宽链路。

