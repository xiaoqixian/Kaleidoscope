# Apple Wireless Direct Link Ad hoc Protocol

### 1. 介绍

​	Apple Wireless Direct Link (AWDL) 是苹果的一项专利协议，其部署在超过12亿的组成苹果用户生态的终端设备之上，使用其的应用包括AirDrop和AirPlay等。

​	AWDL协议有以下几点值得注意：

1. AWDL基于IEEE 802.11 协议，可能存在潜在的性能和共存问题，尤其是在一般环境下，AWDL使用多条信道并且使用跳频技术，可能与现有的Wi-Fi部署存在干扰问题。
2. 在现有版本的macOS中，Wi-Fi驱动是最大的二进制内核扩展。鉴于最近发布的Wi-Fi芯片固件[7,8]中的漏洞可能会导致整个系统对[9]的破坏，我们强烈建议对该协议及其实现进行安全审计，因为非标准化协议中的漏洞更有可能发生。
3. 对该协议重新实现并开源将允许与其它操作系统互操作，最终实现高吞吐量的跨平台直接通信。

​	在本文中，我们通过二进制和运行时分析的方式对AWDL进行了一个详细的分析，并给出了其帧结构和运行方式。简单来说，AWDL是一种基于IEEE 802.11 标准并利用了允许自定义协议实现的供应商扩展来实现的协议。每个AWDL节点会定期发送action frames，其包含了一系列空闲窗口，表明其随时可与其它AWDL节点进行通信。之后一个主节点被选举出来来同步这些窗口序列。在这些空闲窗口中，节点之间可以通过一种专用的数据帧格式来彼此通信。在空闲窗口之外，节点可以将其Wi-Fi无线电调节到另一个频道来与AP点进行通信，或者直接关闭来节省电量。本文所做的工作如下：

- 提供了对于macOS操作系统和其Wi-Fi驱动架构和debugging设施的剖析
- 4到6节提供了AWDL的帧结构和运行方式
- 对AWDL进行了实验性分析来评估选举行为，同步准确性，吞吐量和跳频策略。
- 讨论了协议的复杂度，能量利用效率，并进行了初步的安全性评估，在那一步发现了macOS内核扩展中的权限安全性问题。

### 2. 背景

​	**IEEE 802.11 IBSS**.  IBSS(Independent Basic Service Set，独立基本服务集)模式更为熟知的名字是"ad hoc"模式，该模式创建一个并无特殊控制角色的分布式无线网络。IBSS 可通过在特定频道发送一个带有SSID和BSSID的信标帧(beacon frame)来创建。其它节点也可通过发送带有相同信息的信标帧来加入网络。

​	**Wi-Fi Peer to Peer**.  点对点Wi-Fi，也称为直连Wi-Fi，可以允许在无基站的情况下连接多台设备。在运行过程中，一个节点承担群组所有者(Group Owner，GO)的角色，这与基础架构模式(或BSS)非常相似。GO的角色无法转移到其它设备，如果GO离开了网络，则必须创建一个新的网络。点对点Wi-Fi网络是通过监听单个频道并发送探针到其它所有频道来建立的。这在实际中会给连接过程带来延迟，经过实验发现建立连接的过程会消耗4到10秒[11]。因此发现设备的过程会迅速消耗设备电量。

​	**TDLS**.  隧道直连建立(Tunneled Direct Link Setup, TDLS)是一项IEEE 802.11 标准的扩展，其允许两个处于同一BSS的节点进行直连。在没有TDLS的网络中，所有的节点流量都要通过AP进行，即使两个节点离得很近。TDLS要求两个节点都连接到同一个AP，因为控制帧需要通过AP进行传输，因此无法运用于真实的ad hoc 场景中。

​	**Neighbor Awareness Networking**.  邻节点感知网络(NAN)[35]，也被称为Wi-Fi感知，扩展了IEEE 802.11的接近服务发现。NAN被设计为高能效的，允许在电池供电的设备[12]上连续运行。NAN在Android 8[17]中被支持，但是我们没有找到任何与兼容硬件的设备。NAN依赖于从一个被选举的主节点发送的信标帧。它们同步一个区域内所有设备的时间。在一个短的发现窗口主设置，设备可以打开他们的无线电，交换服务和连接信息(例如，Wi-Fi P2P参数)，并再次关闭他们的收音机。事实上，我们发现AWDL使用了与NAN类似的概念，但实际实现与NAN有很大的不同。此外，NAN没有一个用于传输用户数据的数据路径。

​	**Bluetooth**.  蓝牙是一个有着不同物理和MAC层的独立标准。蓝牙和Wi-Fi一样工作在2.4GHz频域，并且经常和Wi-Fi集成到一个芯片上以共享天线。低能耗蓝牙(Bluetooth Low Energy, BLE)是与经典蓝牙协议不兼容的协议，其为低能源消耗而优化，因此提供的带宽非常有限。可用的BLE4.2 最大数据传输速率为 394 kbit/s[14]。其通常应用于小型电池驱动设备，如智能手表。BLE不是为大数据传输而设计的，但是可以应用于引导像AWDL这样的高带宽链路。

### 3. Methodology

#### 3.1 二进制分析

​	我们分析了大量的与AWDL相关的二进制文件才最终找到了与协议实现相关的部分。我们首先描述了节点选举的过程，然后讨论了实现了大部分AWDL协议的两部分Wi-Fi驱动程序。我们主要分析macOS，并假设其架构在原则上与iOS类似。我们使用反编译器来分析目标二进制文件。

​	**Binaries Selection**.  我们首先根据“802.11”、“Multicast DNS”、“sharing”等名字爬取系统的二进制文件。然后根据它们的依赖找到了更多相关的文件。下图即为找到的部分依赖和彼此的交互方式。

![image-20220620160238757](/Users/lunar/Library/Application Support/typora-user-images/image-20220620160238757.png)

虽然有一些面向用户的二进制文件，比如`sharingd`守护进程，但最相关的二进制文件都位于内核中，特别是通用的Wi- Fi驱动程序 `IO802111family` 和设备特定的变体`AirportBrcm4360`和`AirportBrcmNIC`。它们中的每一个都包含数百个与AWDL相关的函数，这表明协议栈的大部分在这里实现。我们发现`IO802111family`负责AWDL框架的大部分解析和创建，以及维护AWDL状态机。特定于设备的驱动程序处理时间关键的功能，如同步。由于这两个驱动程序部分都是macOS中最大的内核扩展，理解内部驱动程序结构是理解反编译代码的关键。

​	**Finding Interesting Code Segments**.  考虑到macOS的Wi-Fi驱动的大小，我们需要可以迅速找到实现AWDL某部分协议的函数。幸运的是，苹果并未将符号名从二进制文件中剥离出去，因此在符号表中搜索“AWDL”也可以命中一些目标。而且，debug的日志输出也对某个函数的代码段的作用有提示作用。

​	**Leaked Broadcom Driver Source Code**.  我们使用一份过时的博通Wi-Fi驱动，其代码曾发生泄漏，可以作为另一个信息来源。我们在源代码中找到了几个AWDL的引用，但没有一个核心功能。我们怀疑Broadcom使用模块化固件概念，并使用一个中央存储库来实现广泛的功能。像AWDL这样的特殊功能被选择性地提供给他们的客户，比如苹果。比AWDL引用更重要的是源代码中的一些C结构。其中包括同步参数TLV和通道序列TLV等关键结构(详见第5节)。泄露的代码还包含了wl实用程序的源代码，该实用程序为驱动程序提供了调试功能，在第3.2节中有进一步讨论。

​	**Dissecting Structures**.  为了理解驱动的功能，我们需要重构底层的数据结构。泄漏的源代码表明大部分的AWDL相关的函数都使用 `awdl_info` 结构体作为第一个参数。`wlc_dump_awdl`函数可以以可读的形式打印数据，因此是一个适于重构结构体的目标，如下图所示：

```c
bcm_bprintf(a2, "AWDL master home channel = %d\n", awdl_info->master_home_channel);
```

我们的二进制分析结果是一个完整的对于AWDL 的 Wireshark剖析，我们也使用它来动态分析协议和评估我们的实验。

#### 3.2 运行时分析

​	单靠二进制分析很难完全理解协议的运行原理。为了理解同步、选择、服务发现和数据路径的语义，我们用动态方法补充了静态分析。在本节中，我们将讨论帮助分析该协议的专用macOS日志记录和调试工具。特别是 *Console* 应用，`ioctl` 接口，博通泄漏的 `wl` 组件以及苹果尚未给出文档的 *CoreCapture* 框架。最后一个尤其详细，但是需要我们通过Wireshark进行额外的分析，因为其使用一套私有的数据形结构。

​	**Apple Console**.  自从 macOS10.12 以后，*Console* 就成了最常用的访问日志和内核的debug信息的应用。为了接收到Wi-Fi驱动的详细输出，我们可以在 boot 参数中增加输出日志的等级，这些参数是通过搜索Wi-Fi驱动中对 `PE_parse_boot_arg` 函数的相关引用找到的。在增加日志等级之后，*Console* 会显示额外的信息，例如状态转移和现在的频道序列。

​	**`ioctl` Interface**.  `ioctl` 系统调用是类unix系统中访问设备的标准方式。苹果通过`ioctl`来设置无线设备，如链接AP或创建一个IBSS。Apple为macOS 10.5提供了请求格式、可用请求类型和数据结构的头文件。这些旧的头文件可以使用来自二进制分析的信息更新。`apple8021virtualrequest`方法包含对所有处理函数的调用。在72个可用的请求id中，40个与AWDL相关。这些请求可以在驱动程序中设置几个参数。特别有用的是特定于网卡的ioctl。它允许在Apple ioctl中封装一个Broadcom特定的`ioctl`，为我们提供了一个与Broadcom驱动程序的直接接口。注意，自从苹果修复了我们报告的漏洞(第8节)后，再也不可能发送broadcom特定的`ioctls`：驱动现在需要检查一个私有的授权安全许可\[2\](com.apple.driver.AirPort.Broadcom.ioctl- access)，该许可需要依赖一个苹果私钥签名的二进制文件。通过使用如[16]中的内核扩展补丁框架来覆写对应的权限检查函数以恢复无限制的`ioctl`访问应该是可能的。驱动补丁需要禁用苹果的*System Integrity Protection*.

​	**Broadcom `wl` Utility**.  在博通泄漏的源代码中找到的`wl`组件找到了几种可访问到AWDL工作方式的内部信息的方式，这些都与二进制分析中找到的一些结构体直接相关。尽管泄漏的源码中并没有AWDL特定的驱动代码，`wl` 源码中还是包含AWDL相关的命令和结构体。`wl`可以允许通过`dump awdl`和 `awdl_advertisers`之类的命令来访问现在的AWDL驱动状态。这在之后会显示一些包含RSSI在内的邻节点的信息。

​	**CoreCapture Framework**.  CoreCapture 是苹果在iOS和macOS上对于 IEEE 802.11 标准的主要日志和追踪框架。CoreCapture 结合原始的协议追踪和传统的日志项，提供对于设备和驱动状态的快照。CoreCapture 并未提供文档，但是我们在驱动中找到的 `dumpPacket` 函数有所涉及。由于该框架输出(包括其他日志和内存转储)大量带有自定义头格式的PCAP跟踪文件，所以我们为CoreCapture编写了一个Wireshark剖析器，并将其公开[23]。此外，我们还发布了一本使用本文[22]编写的CoreCapture手册。

### 4. AWDL 概览

