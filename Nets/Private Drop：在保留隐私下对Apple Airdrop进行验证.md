# Private Drop：在保留隐私下对Apple Airdrop进行验证

### 介绍

​	Apple的Airdrop功能是一项集成于15亿多终端设备的文件共享功能。Airdrop完全离线运行，通过两个用户间Wi-Fi直连结合低功率蓝牙实现。我们在底层的认证协议中发现两个非常严重的隐私漏洞，尤其是这些漏洞可以使得别人从附近的Airdrop发送者和接收者中收集到联系人认证信息（包括手机号和邮箱）。这些缺陷起源于在发现周围人时联系人识别码的哈希值的交换过程，使得Airdrop可以通过暴力破解或字典攻击的方式被反向破解。

​	在认证过程中，两台Airdrop设备运行*发现联系人*来判断彼此是否互为联系人，不管他们是否在彼此的电话簿中存有彼此的联系人信息。只有当结果为肯定时认证才会成功。

​	隐私保护的联系人发现过程通常通过PSI（Private Set Intersection）协议实现。PSI是一种允许两个交互的群体能够安全地计算彼此输入集合的交集而不泄漏任何额外信息的密文协议。PSI协议在实际中已经有所运用，如chrome浏览器在B2C场景下用于妥协性凭证检查。

​	而Airdrop的使用场景面临着另外一组挑战：

1. 没有任何第三方服务器的支持下完全离线运行
2. 考虑恶意方对他们的地址簿或自己的联系人标识符作假
3. 在电量和计算资源有限的移动设备上运行
4. 通过不增加明显的身份验证延迟来保证用户体验

​	我们研究了PSI的应用型来理解Airdrop的私有双向验证。为此，我们首先系统地探索了文献中所有可能的设计选项和可用的构建模块。 我们最终的解决方案名为PrivateDrop，它基于Diffie-Hellman风格的PSI协议[53]，即使在恶意行动者主动试图提取敏感信息的情况下，它也是安全的。 我们采用[53]的双向变体，通过最小化通信轮数和允许预先计算昂贵的操作(例如，设备在夜间充电时)来优化在线性能。 为了适应恶意输入，特别是那些谎报联系标识符的攻击者，我们建议使用签名的PSI输入[21,31,33]来补充AirDrop当前的验证记录，并且可以使用苹果现有的认证基础设施来发布。

​	此外，我们将PrivateDrop集成进了原有的Airdrop协议栈，包括基于低功率蓝牙的发现机制和基于HTTPS的认证阶段。我们为iOS和macOS同时实现了原有的Airdrop协议和我们的PrivateDrop扩展，并且在GitHub[开源](https://github.com/seemoo-lab/privatedrop.git)。

​	最终，经过大范围的性能评估，我们验证PrivateDrop只会带来可以忽略的额外开销。尤其，我们实验了在超过10k的地址项的通讯簿中验证的延迟也低于1s。

### 2. Airdrop 背景介绍

​	Airdrop至今仍未公布任何有关涉及的协议栈的文档，我们所描述的Airdrop工作过程建立在逆向工程的基础上。

#### 2.1 联系人标识符和地址簿

​	Airdrop使用电话和邮箱地址来确认一个联系人，因为每个Apple账号至少绑定了其中一项。在本文场景下，不管是邮箱还是电话号码，都被认为是地址标识符。我们认为在本机上存在一个确定的从联系人信息到联系人标识符的映射，我们用*地址簿* 来指代所有联系人信息的联系人标识符的集合。

#### 2.2 全协议工作流程

​	Airdrop的协议主要包括三个阶段：*发现设备*，*认证* 和 *数据传输*。

![Screen Shot 2022-06-19 at 11.42.18 AM](/Users/lunar/Library/Application Support/typora-user-images/Screen Shot 2022-06-19 at 11.42.18 AM.png)