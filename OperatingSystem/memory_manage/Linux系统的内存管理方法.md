### **操作系統3-內存管理(Linux系統的內存管理方法)**

#### 9.**Linux系統的內存管理方法**

Linux採用“按需調頁”算法，支持三層管理策略。由於Intel CPU在硬件級提供了段式存儲管理和二層頁式存儲管理，Linux作為軟件，必須與之兼容。所以Linux實際上放棄了段式存儲管理，將第二層的頁式管理與第一層的頁式管理合併，因此整整發揮作用的是以**頁目錄和頁表為中心的數據結構和函數。**

9.1 **Linux的分頁管理機制**

在Linux中，每個進程都可以訪問4GB的線性虛擬內存空間，注意可以訪問的空間和實際享有的空間並不是一回事。其中0~3GB的虛擬內存地址空間為用戶空間，用戶進程可以直接訪問；3~4GB的空間為內核態空間，存放僅供內核態訪問的代碼和數據，當用戶進程通過中斷或系統調用訪問內核態空間時，就會觸發處理特權級轉換，從用戶態轉到內核態。

**所有進程從3GB到4GB的虛擬空間是一樣的，有相同的頁目錄項和頁表，對應同樣的物理內存段，Linux以此方式讓內核態進程共享代碼段和數據段。**

Linux採用“按需調頁”管理內存，標準Linux的虛存頁表為3級頁表，依次為頁目錄(Page Directory, PGD)、中間頁目錄(Page Middle Directory, PMD)和頁表(Page Table, PTE)。

而在Intel微型計算機上，Linux的頁表結構實際只有兩級，PGD和PMD合二為一，在用戶進程通過mm_struct結構來管理進程中與存儲相關的信息。

9.2 **虛存段的組織與管理**

為了能夠自然地管理進程虛存空間，Linux定義了虛存段(virtual memory are, vma)，一個vma段時某個進程的一段連續的虛擬空間，在這段虛擬空間的所有單元擁有相同的特征。例如屬於同一進程，有相同的訪問權限等。

9.3 **內存的共享**

Linux內存的共享並不設置一個共享頁表，而是讓共享該頁的各進程的頁表項直接指向共享頁。這種方式節約內存，但是效率較低。

9.4 **內存空間管理**

Linux物理空間以頁幀為單位，就相當於前面講的物理塊，大小等於頁長，對於Intel CPU默認是4KB。

Linux對物理內存的管理通過mem_map來描述，mem_map在系統初始化時，由free_area_init()來創建。用bitmap記錄所有物理內存的空閒情況，也有這個函數創建。